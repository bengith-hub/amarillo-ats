<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amarillo ATS ‚Äî R√©f√©rentiels</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/tailwind.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" type="image/png" href="AS_logo_only.png" />
</head>
<body>
  <nav class="sidebar">
    <div class="sidebar-logo"><img src="AS_logo_only.png" alt="Amarillo" class="sidebar-logo-icon" />Amarillo ATS</div>
    <div class="sidebar-nav">
      <a href="index.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>Dashboard</a>
      <a href="candidats.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Candidats</a>
      <a href="missions.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Missions</a>
      <a href="entreprises.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>Entreprises</a>
      <a href="decideurs.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>D√©cideurs</a>
      <a href="carte.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>Carte</a>
      <a href="actions.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Actions</a>
      <a href="signaux.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>Signaux</a>
      <a href="facturation.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Facturation</a>
      <a href="referentiels.html" class="active"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>R√©f√©rentiels</a>
    </div>
    <div style="padding:12px 20px;border-top:1px solid #334155;"><button onclick="UI.showConfigModal()" class="btn btn-secondary" style="width:100%;justify-content:center;font-size:0.75rem;">Configuration API</button></div>
  </nav>

  <div class="main-content">
    <header class="topbar" data-entity="dashboard">
      <h1 class="topbar-title">R√©f√©rentiels & Configuration</h1>
      <div class="search-global"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" placeholder="Rechercher..." /><div class="search-results-dropdown"></div></div>
      <button class="btn btn-danger btn-sm" id="btn-reset-all">R√©initialiser tout</button>
    </header>

    <div class="page-content">
      <div style="margin-bottom:24px;">
        <p style="font-size:0.875rem;color:#64748b;">
          Configurez ici toutes les listes de valeurs utilis√©es dans l'ATS : statuts, types, secteurs, sources, etc.
          Les modifications sont sauvegard√©es automatiquement. Chaque valeur ajout√©e sera disponible dans les filtres et formulaires.
        </p>
      </div>

      <div id="ref-categories"></div>
    </div>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="js/config.js"></script>
  <script src="js/backup-monitor.js"></script>
  <script src="js/api.js"></script>
  <script src="js/store.js"></script>
  <script src="js/components.js"></script>
  <script src="js/google-auth.js"></script>
  <script src="js/google-drive.js"></script>
  <script src="js/backup.js"></script>
  <script src="js/referentiels.js"></script>
  <script src="js/templates.js"></script>
  <script>
  (async function() {
    if (!API.isConfigured()) { UI.showConfigModal(); return; }
    await Store.loadAll();
    UI.initGlobalSearch();

    const categories = Referentiels.getCategories();
    const container = document.getElementById('ref-categories');

    // Render category tabs + content
    let activeCategory = categories[0].id;

    function render() {
      container.innerHTML = `
        <div class="ref-tabs">
          ${categories.map(cat => `
            <button class="ref-tab ${cat.id === activeCategory ? 'active' : ''}" data-cat="${cat.id}" style="${cat.id === activeCategory ? `border-color:${cat.color};color:${cat.color};` : ''}">
              <span>${cat.icon}</span> ${cat.label}
            </button>
          `).join('')}
          <button class="ref-tab ${'trames' === activeCategory ? 'active' : ''}" data-cat="trames" style="${'trames' === activeCategory ? 'border-color:#c9a000;color:#c9a000;' : ''}">
            <span>üìù</span> Trames
          </button>
          <button class="ref-tab ${'sauvegardes' === activeCategory ? 'active' : ''}" data-cat="sauvegardes" style="${'sauvegardes' === activeCategory ? 'border-color:#0ea5e9;color:#0ea5e9;' : ''}">
            <span>üíæ</span> Sauvegardes
          </button>
        </div>
        <div class="ref-content">
          ${activeCategory === 'sauvegardes' ? renderBackupTab() : activeCategory === 'trames' ? renderTramesTab() : categories.filter(cat => cat.id === activeCategory).map(cat => `
            <div class="ref-items-grid">
              ${cat.items.map(item => {
                const values = Referentiels.get(item.key);
                return `
                  <div class="card ref-list-card" style="border-left:3px solid ${cat.color};">
                    <div class="card-header">
                      <h2>${item.label}</h2>
                      <span style="font-size:0.6875rem;color:#94a3b8;">${values.length} valeurs</span>
                    </div>
                    <div class="card-body">
                      <div class="ref-values-list" data-key="${item.key}">
                        ${values.map((val, idx) => `
                          <div class="ref-value-item" data-idx="${idx}" draggable="true">
                            <span class="ref-value-handle" title="Glisser pour r√©ordonner">‚†ø</span>
                            <span class="ref-value-text">${UI.badge(val)}</span>
                            <button class="ref-value-delete" data-key="${item.key}" data-val="${UI.escHtml(val)}" title="Supprimer">‚úï</button>
                          </div>
                        `).join('')}
                      </div>
                      <div class="ref-add-form" style="margin-top:8px;display:flex;gap:6px;">
                        <input type="text" class="ref-add-input" data-key="${item.key}" placeholder="Ajouter une valeur..." style="flex:1;padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.8125rem;" />
                        <button class="btn btn-primary btn-sm ref-add-btn" data-key="${item.key}">+</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('')}
        </div>
      `;

      // Bind tab clicks
      container.querySelectorAll('.ref-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          activeCategory = tab.dataset.cat;
          render();
        });
      });

      // Bind delete buttons
      container.querySelectorAll('.ref-value-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const key = btn.dataset.key;
          const val = btn.dataset.val;
          Referentiels.removeValue(key, val);
          UI.toast(`"${val}" supprim√©`);
          render();
        });
      });

      // Bind add buttons and Enter key
      container.querySelectorAll('.ref-add-btn').forEach(btn => {
        btn.addEventListener('click', () => addValue(btn.dataset.key));
      });
      container.querySelectorAll('.ref-add-input').forEach(input => {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addValue(input.dataset.key);
          }
        });
      });

      // Bind inline editing (click on value text to edit)
      container.querySelectorAll('.ref-value-text').forEach(span => {
        span.addEventListener('dblclick', () => {
          const item = span.closest('.ref-value-item');
          const listEl = item.closest('.ref-values-list');
          const key = listEl.dataset.key;
          const idx = parseInt(item.dataset.idx);
          const values = Referentiels.get(key);
          const oldVal = values[idx];

          const input = document.createElement('input');
          input.type = 'text';
          input.value = oldVal;
          input.className = 'ref-edit-input';
          input.style.cssText = 'width:100%;padding:2px 6px;border:1px solid var(--primary);border-radius:4px;font-size:0.8125rem;outline:none;';
          span.replaceWith(input);
          input.focus();
          input.select();

          const finish = () => {
            const newVal = input.value.trim();
            if (newVal && newVal !== oldVal) {
              values[idx] = newVal;
              Referentiels.set(key, values);
              UI.toast(`"${oldVal}" ‚Üí "${newVal}"`);
            }
            render();
          };
          input.addEventListener('blur', finish);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') render();
          });
        });
      });

      // Drag & drop reordering
      container.querySelectorAll('.ref-values-list').forEach(list => {
        let dragIdx = null;
        list.querySelectorAll('.ref-value-item').forEach(item => {
          item.addEventListener('dragstart', (e) => {
            dragIdx = parseInt(item.dataset.idx);
            item.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
          });
          item.addEventListener('dragend', () => {
            item.style.opacity = '1';
          });
          item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            item.style.borderTop = '2px solid var(--primary)';
          });
          item.addEventListener('dragleave', () => {
            item.style.borderTop = '';
          });
          item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.style.borderTop = '';
            const toIdx = parseInt(item.dataset.idx);
            if (dragIdx !== null && dragIdx !== toIdx) {
              Referentiels.reorder(list.dataset.key, dragIdx, toIdx);
              UI.toast('Ordre mis √† jour');
              render();
            }
          });
        });
      });

      // Bind trames tab events
      if (activeCategory === 'trames') bindTramesEvents();
      if (activeCategory === 'sauvegardes') bindBackupEvents();
    }

    function addValue(key) {
      const input = container.querySelector(`.ref-add-input[data-key="${key}"]`);
      if (!input) return;
      const val = input.value.trim();
      if (!val) return;

      const existing = Referentiels.get(key);
      if (existing.includes(val)) {
        UI.toast('Valeur d√©j√† existante', 'error');
        return;
      }

      Referentiels.addValue(key, val);
      UI.toast(`"${val}" ajout√©`);
      render();
    }

    function renderTramesTab() {
      const allTemplates = TemplatesStore.loadAll();
      const cats = TemplatesStore.getCategories();

      let html = '<div style="margin-bottom:16px;display:flex;justify-content:flex-end;">';
      html += '<button class="btn btn-primary btn-sm" id="btn-new-trame">+ Nouvelle trame</button>';
      html += '</div>';

      for (const [catName, keys] of Object.entries(cats)) {
        const validKeys = keys.filter(k => allTemplates[k]);
        if (validKeys.length === 0) continue;

        html += `<div style="margin-bottom:20px;">`;
        html += `<div style="font-size:0.75rem;font-weight:700;color:#64748b;text-transform:uppercase;margin-bottom:8px;">${catName}</div>`;
        html += `<div class="ref-items-grid">`;

        for (const key of validKeys) {
          const tpl = allTemplates[key];
          html += `
            <div class="card ref-list-card" style="border-left:3px solid #c9a000;">
              <div class="card-header">
                <h2><span style="margin-right:6px;">${tpl.icon}</span>${UI.escHtml(tpl.title)}</h2>
                <span style="font-size:0.6875rem;color:#94a3b8;">${tpl.sections.length} sections</span>
              </div>
              <div class="card-body">
                <div style="font-size:0.8125rem;color:#64748b;margin-bottom:10px;">
                  ${tpl.sections.map(s => `<span style="display:inline-block;background:#f1f5f9;border-radius:4px;padding:2px 8px;margin:2px;font-size:0.75rem;">${UI.escHtml(s.title)}</span>`).join('')}
                </div>
                <div style="display:flex;gap:6px;">
                  <button class="btn btn-secondary btn-sm tpl-preview-btn" data-key="${key}" style="flex:1;">Aper√ßu</button>
                  <button class="btn btn-primary btn-sm tpl-edit-btn" data-key="${key}" style="flex:1;">Modifier</button>
                  <button class="btn btn-sm tpl-delete-btn" data-key="${key}" style="color:#dc2626;padding:4px 10px;" title="Supprimer">‚úï</button>
                </div>
              </div>
            </div>
          `;
        }

        html += `</div></div>`;
      }

      return html;
    }

    function bindTramesEvents() {
      // New template
      document.getElementById('btn-new-trame')?.addEventListener('click', () => {
        showTemplateEditor(null, () => render());
      });

      // Preview buttons
      container.querySelectorAll('.tpl-preview-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          showTemplateDetail(btn.dataset.key, {});
        });
      });

      // Edit buttons
      container.querySelectorAll('.tpl-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          showTemplateEditor(btn.dataset.key, () => render());
        });
      });

      // Delete buttons
      container.querySelectorAll('.tpl-delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.key;
          const tpl = TemplatesStore.get(key);
          UI.modal('Supprimer la trame', `
            <p>Supprimer <strong>"${UI.escHtml(tpl?.title || key)}"</strong> ?</p>
            <p style="font-size:0.875rem;color:#64748b;margin-top:8px;">Cette action est irr√©versible.</p>
          `, {
            saveLabel: 'Supprimer',
            onSave: () => {
              TemplatesStore.remove(key);
              UI.toast('Trame supprim√©e');
              render();
            }
          });
        });
      });
    }

    // ‚îÄ‚îÄ‚îÄ Backup tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function renderBackupTab() {
      const lastBackup = Backup.getLastBackupDate();
      const lastStr = lastBackup ? Backup.formatDate(lastBackup) : 'Aucun';

      return `
        <!-- Statut du backup automatique -->
        <div id="backup-status-card" style="margin-bottom:20px;">
          <div class="card" style="border-left:4px solid #94a3b8;">
            <div class="card-body" style="display:flex;align-items:center;gap:12px;padding:14px 20px;">
              <span style="font-size:1.25rem;" id="backup-status-icon">&#9203;</span>
              <div style="flex:1;">
                <div style="font-size:0.8125rem;font-weight:600;color:#1e293b;" id="backup-status-text">V\u00e9rification du backup automatique...</div>
                <div style="font-size:0.75rem;color:#94a3b8;" id="backup-status-detail"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="backup-grid">

          <!-- Export local -->
          <div class="card backup-card" style="border-left:3px solid #0ea5e9;">
            <div class="card-header">
              <h2>üì• Export local</h2>
            </div>
            <div class="card-body">
              <p style="font-size:0.8125rem;color:#64748b;margin-bottom:12px;">
                T√©l√©chargez toutes vos donn√©es au format JSON pour une sauvegarde locale sur votre ordinateur.
              </p>
              <button class="btn btn-primary btn-sm" id="btn-backup-export">üì• Exporter les donn√©es</button>
            </div>
          </div>

          <!-- Import / Restauration -->
          <div class="card backup-card" style="border-left:3px solid #f59e0b;">
            <div class="card-header">
              <h2>üì§ Import / Restauration</h2>
            </div>
            <div class="card-body">
              <p style="font-size:0.8125rem;color:#64748b;margin-bottom:8px;">
                Restaurez vos donn√©es depuis un fichier JSON pr√©c√©demment export√©.
              </p>
              <p style="font-size:0.75rem;color:#dc2626;margin-bottom:12px;">
                ‚ö†Ô∏è Cette op√©ration remplacera toutes les donn√©es actuelles.
              </p>
              <input type="file" id="backup-file-input" accept=".json" style="display:none;" />
              <button class="btn btn-secondary btn-sm" id="btn-backup-import">üì§ Importer un fichier</button>
            </div>
          </div>

          <!-- Google Drive -->
          <div class="card backup-card" style="border-left:3px solid #22c55e;">
            <div class="card-header">
              <h2>‚òÅÔ∏è Google Drive</h2>
            </div>
            <div class="card-body">
              <p style="font-size:0.8125rem;color:#64748b;margin-bottom:8px;">
                Sauvegardez sur Google Drive ou restaurez depuis une sauvegarde pr√©c√©dente.
              </p>
              <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:12px;">
                Dernier backup : <strong>${lastStr}</strong>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" id="btn-backup-drive">‚òÅÔ∏è Sauvegarder sur Drive</button>
                <button class="btn btn-secondary btn-sm" id="btn-backup-drive-list">üìã Voir les backups</button>
              </div>
            </div>
          </div>

          <!-- Snapshots automatiques -->
          <div class="card backup-card" style="border-left:3px solid #8b5cf6;">
            <div class="card-header">
              <h2>üì∏ Snapshots automatiques</h2>
            </div>
            <div class="card-body">
              <p style="font-size:0.8125rem;color:#64748b;margin-bottom:8px;">
                Backup automatique quotidien (3h du matin). Les 7 derniers snapshots sont conserv√©s.
              </p>
              <div id="snapshots-list" style="margin-bottom:12px;">
                <div style="font-size:0.8125rem;color:#94a3b8;">Chargement...</div>
              </div>
              <button class="btn btn-secondary btn-sm" id="btn-backup-snapshot">üîÑ Cr√©er un snapshot maintenant</button>
            </div>
          </div>

        </div>
      `;
    }

    function bindBackupEvents() {
      // Check backup status
      loadBackupStatus();

      // Export local
      document.getElementById('btn-backup-export')?.addEventListener('click', () => {
        try {
          const counts = Backup.exportAll();
          const total = Object.values(counts).reduce((a, b) => a + b, 0);
          UI.toast('Backup export√© (' + total + ' enregistrements)');
        } catch (e) {
          UI.toast('Erreur export : ' + e.message, 'error');
        }
      });

      // Import
      const fileInput = document.getElementById('backup-file-input');
      document.getElementById('btn-backup-import')?.addEventListener('click', () => {
        fileInput?.click();
      });

      fileInput?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const result = await Backup.parseBackupFile(file);

          const summaryHtml = `
            <p style="margin-bottom:12px;">Fichier : <strong>${UI.escHtml(file.name)}</strong></p>
            ${result.meta ? '<p style="font-size:0.8125rem;color:#64748b;margin-bottom:12px;">Date du backup : ' + Backup.formatDate(result.meta.date) + '</p>' : ''}
            <table style="width:100%;font-size:0.8125rem;border-collapse:collapse;">
              <thead><tr style="border-bottom:1px solid #e2e8f0;"><th style="text-align:left;padding:6px 8px;">Entit√©</th><th style="text-align:right;padding:6px 8px;">Enregistrements</th></tr></thead>
              <tbody>
                ${Backup.ENTITIES.map(e => '<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:6px 8px;">' + e + '</td><td style="text-align:right;padding:6px 8px;font-weight:600;">' + (result.counts[e] || 0) + '</td></tr>').join('')}
              </tbody>
              <tfoot><tr style="border-top:2px solid #e2e8f0;font-weight:700;"><td style="padding:6px 8px;">Total</td><td style="text-align:right;padding:6px 8px;">${result.totalRecords}</td></tr></tfoot>
            </table>
            <p style="color:#dc2626;font-size:0.8125rem;margin-top:16px;font-weight:600;">‚ö†Ô∏è Toutes les donn√©es actuelles seront remplac√©es par celles du fichier.</p>
          `;

          UI.modal('Confirmer la restauration', summaryHtml, {
            width: 500,
            saveLabel: 'Restaurer',
            onSave: async () => {
              UI.toast('Restauration en cours...');
              try {
                await Backup.restoreFromData(result.data, (entity, done, total) => {
                  if (entity) UI.toast('Restauration : ' + entity + '...');
                });
                UI.toast('Restauration termin√©e ! Rechargement...');
                setTimeout(() => window.location.reload(), 1500);
              } catch (err) {
                UI.toast('Erreur restauration : ' + err.message, 'error');
              }
            }
          });
        } catch (err) {
          UI.toast('Erreur : ' + err.message, 'error');
        }

        fileInput.value = '';
      });

      // Google Drive backup
      document.getElementById('btn-backup-drive')?.addEventListener('click', async () => {
        if (!GoogleAuth.isConfigured()) {
          UI.toast('Configurez d\'abord Google (Configuration API dans la sidebar)', 'error');
          return;
        }

        try {
          UI.toast('Sauvegarde Google Drive en cours...');
          const result = await Backup.backupToGoogleDrive();
          const total = Object.values(result.counts).reduce((a, b) => a + b, 0);
          UI.toast('Sauvegard√© sur Drive : ' + result.fileName + ' (' + total + ' enregistrements)');
          render(); // refresh last backup date
        } catch (e) {
          UI.toast('Erreur Drive : ' + e.message, 'error');
        }
      });

      // Google Drive list
      document.getElementById('btn-backup-drive-list')?.addEventListener('click', async () => {
        if (!GoogleAuth.isConfigured()) {
          UI.toast('Configurez d\'abord Google (Configuration API dans la sidebar)', 'error');
          return;
        }

        try {
          UI.toast('Chargement des backups Drive...');
          const files = await Backup.listDriveBackups();

          if (files.length === 0) {
            UI.toast('Aucun backup trouv√© sur Google Drive');
            return;
          }

          const listHtml = `
            <div style="max-height:400px;overflow-y:auto;">
              ${files.map(f => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #f1f5f9;">
                  <div>
                    <div style="font-size:0.8125rem;font-weight:600;color:#1e293b;">${UI.escHtml(f.name)}</div>
                    <div style="font-size:0.75rem;color:#94a3b8;">${Backup.formatDate(f.createdTime)} ${f.size ? '‚Äî ' + Backup.formatSize(parseInt(f.size)) : ''}</div>
                  </div>
                  <button class="btn btn-secondary btn-sm drive-restore-btn" data-file-id="${f.id}" data-name="${UI.escHtml(f.name)}">Restaurer</button>
                </div>
              `).join('')}
            </div>
          `;

          UI.modal('Backups Google Drive', listHtml, { width: 560 });

          // Bind restore buttons
          setTimeout(() => {
            document.querySelectorAll('.drive-restore-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const fileId = btn.dataset.fileId;
                const name = btn.dataset.name;

                try {
                  UI.toast('T√©l√©chargement de ' + name + '...');
                  const result = await Backup.restoreFromDrive(fileId);

                  // Close the list modal and show confirmation
                  document.getElementById('modal-overlay')?.classList.remove('visible');

                  const summaryHtml = `
                    <p style="margin-bottom:12px;">Backup : <strong>${UI.escHtml(name)}</strong></p>
                    <table style="width:100%;font-size:0.8125rem;border-collapse:collapse;">
                      <tbody>
                        ${Backup.ENTITIES.map(e => '<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:6px 8px;">' + e + '</td><td style="text-align:right;padding:6px 8px;font-weight:600;">' + (result.counts[e] || 0) + '</td></tr>').join('')}
                      </tbody>
                    </table>
                    <p style="color:#dc2626;font-size:0.8125rem;margin-top:16px;font-weight:600;">‚ö†Ô∏è Toutes les donn√©es actuelles seront remplac√©es.</p>
                  `;

                  UI.modal('Confirmer la restauration', summaryHtml, {
                    width: 500,
                    saveLabel: 'Restaurer',
                    onSave: async () => {
                      UI.toast('Restauration en cours...');
                      await Backup.restoreFromData(result.data);
                      UI.toast('Restauration termin√©e ! Rechargement...');
                      setTimeout(() => window.location.reload(), 1500);
                    }
                  });
                } catch (err) {
                  UI.toast('Erreur : ' + err.message, 'error');
                }
              });
            });
          }, 100);
        } catch (e) {
          UI.toast('Erreur : ' + e.message, 'error');
        }
      });

      // Snapshots ‚Äî load list
      loadSnapshotsList();

      // Create snapshot
      document.getElementById('btn-backup-snapshot')?.addEventListener('click', async () => {
        try {
          UI.toast('Cr√©ation du snapshot en cours...');
          await Backup.createSnapshot('manual');
          UI.toast('Snapshot cr√©√© avec succ√®s');
          loadSnapshotsList();
        } catch (e) {
          UI.toast('Erreur snapshot : ' + e.message, 'error');
        }
      });
    }

    async function loadSnapshotsList() {
      const listEl = document.getElementById('snapshots-list');
      if (!listEl) return;

      try {
        const snapshots = await Backup.listSnapshots();

        if (snapshots.length === 0) {
          listEl.innerHTML = '<div style="font-size:0.8125rem;color:#94a3b8;padding:8px 0;">Aucun snapshot disponible.</div>';
          return;
        }

        listEl.innerHTML = snapshots.map(s => {
          const total = s.counts ? Object.values(s.counts).reduce((a, b) => a + b, 0) : '?';
          return `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #f1f5f9;">
              <div>
                <span style="font-size:0.8125rem;color:#1e293b;">üì∏ ${Backup.formatDate(s.date)}</span>
                <span style="font-size:0.6875rem;color:#94a3b8;margin-left:8px;">${s.source} ‚Äî ${total} enregistrements</span>
              </div>
              <button class="btn btn-secondary btn-sm snapshot-restore-btn" data-snap-id="${s.id}" style="font-size:0.75rem;padding:4px 10px;">Restaurer</button>
            </div>
          `;
        }).join('');

        // Bind restore buttons
        listEl.querySelectorAll('.snapshot-restore-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const snapId = btn.dataset.snapId;

            try {
              UI.toast('Chargement du snapshot...');
              const snapshot = await Backup.getSnapshot(snapId);
              if (!snapshot) {
                UI.toast('Snapshot introuvable', 'error');
                return;
              }

              const total = snapshot.counts ? Object.values(snapshot.counts).reduce((a, b) => a + b, 0) : 0;
              const summaryHtml = `
                <p style="margin-bottom:12px;">Snapshot du <strong>${Backup.formatDate(snapshot.date)}</strong> (${snapshot.source})</p>
                <table style="width:100%;font-size:0.8125rem;border-collapse:collapse;">
                  <tbody>
                    ${Backup.ENTITIES.map(e => '<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:6px 8px;">' + e + '</td><td style="text-align:right;padding:6px 8px;font-weight:600;">' + (snapshot.counts[e] || 0) + '</td></tr>').join('')}
                  </tbody>
                  <tfoot><tr style="border-top:2px solid #e2e8f0;font-weight:700;"><td style="padding:6px 8px;">Total</td><td style="text-align:right;padding:6px 8px;">${total}</td></tr></tfoot>
                </table>
                <p style="color:#dc2626;font-size:0.8125rem;margin-top:16px;font-weight:600;">‚ö†Ô∏è Toutes les donn√©es actuelles seront remplac√©es.</p>
              `;

              UI.modal('Confirmer la restauration', summaryHtml, {
                width: 500,
                saveLabel: 'Restaurer',
                onSave: async () => {
                  UI.toast('Restauration en cours...');
                  await Backup.restoreFromData(snapshot.data);
                  UI.toast('Restauration termin√©e ! Rechargement...');
                  setTimeout(() => window.location.reload(), 1500);
                }
              });
            } catch (err) {
              UI.toast('Erreur : ' + err.message, 'error');
            }
          });
        });
      } catch (e) {
        listEl.innerHTML = '<div style="font-size:0.8125rem;color:#dc2626;">Erreur chargement snapshots : ' + e.message + '</div>';
      }
    }

    async function loadBackupStatus() {
      const card = document.getElementById('backup-status-card');
      if (!card) return;

      try {
        const status = await BackupMonitor.fetchBackupStatus();
        const iconEl = document.getElementById('backup-status-icon');
        const textEl = document.getElementById('backup-status-text');
        const detailEl = document.getElementById('backup-status-detail');
        const cardInner = card.querySelector('.card');

        if (!status || !status.last_success) {
          // Check if there's a recent local/manual backup success
          const localSuccess = localStorage.getItem('ats_backup_last_success');
          if (localSuccess) {
            const localDate = new Date(localSuccess).toLocaleDateString('fr-FR', {
              day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            iconEl.innerHTML = '&#9989;';
            textEl.textContent = 'Backup manuel actif';
            textEl.style.color = '#16a34a';
            detailEl.textContent = 'Dernier backup r\u00e9ussi : ' + localDate + '. Cr\u00e9ez un snapshot pour activer le suivi automatique.';
            cardInner.style.borderLeftColor = '#22c55e';
          } else {
            iconEl.innerHTML = '&#9888;&#65039;';
            textEl.textContent = 'Backup automatique non configur\u00e9';
            detailEl.textContent = 'Cr\u00e9ez un premier snapshot ci-dessous pour activer le suivi automatique des backups.';
            cardInner.style.borderLeftColor = '#f59e0b';
          }
          return;
        }

        const isStale = BackupMonitor.isBackupStale(status);
        const lastDate = new Date(status.last_success).toLocaleDateString('fr-FR', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        if (isStale || status.result === 'error') {
          iconEl.innerHTML = '&#10060;';
          textEl.textContent = 'Backup en \u00e9chec';
          textEl.style.color = '#dc2626';
          cardInner.style.borderLeftColor = '#dc2626';
          let detail = 'Dernier succ\u00e8s : ' + lastDate;
          if (status.error) detail += ' \u2014 Erreur : ' + status.error;
          detailEl.textContent = detail;
        } else {
          const hasDrive = status.drive_backup === true;
          iconEl.innerHTML = '&#9989;';
          textEl.textContent = hasDrive ? 'Backup automatique Google Drive actif' : 'Backup automatique fonctionnel';
          textEl.style.color = '#16a34a';
          cardInner.style.borderLeftColor = '#22c55e';
          let detail = 'Dernier backup r\u00e9ussi : ' + lastDate;
          if (status.drive_file) detail += ' \u2014 ' + status.drive_file;
          detailEl.textContent = detail;
        }
      } catch (e) {
        console.warn('Could not check backup status:', e.message);
      }
    }

    render();

    // Reset all button
    document.getElementById('btn-reset-all').addEventListener('click', () => {
      UI.modal('R√©initialiser les r√©f√©rentiels', `
        <p style="color:#dc2626;font-weight:600;margin-bottom:12px;">Attention : cette action va remettre tous les r√©f√©rentiels √† leurs valeurs par d√©faut.</p>
        <p style="font-size:0.875rem;color:#64748b;">Toutes vos personnalisations (ajouts, suppressions, r√©organisations) seront perdues.</p>
      `, {
        saveLabel: 'R√©initialiser',
        onSave: () => {
          Referentiels.resetAll();
          UI.toast('R√©f√©rentiels r√©initialis√©s');
          render();
        }
      });
    });
  })();
  </script>

  <style>
    .ref-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    .ref-tab {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: 2px solid transparent;
      background: #fff;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.15s;
    }
    .ref-tab:hover { background: #f8fafc; color: #1e293b; }
    .ref-tab.active { background: #fff; font-weight: 600; border-bottom-width: 2px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

    .ref-items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .ref-list-card { margin-bottom: 0; }

    .ref-values-list { }

    .ref-value-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      transition: background 0.1s;
      border-bottom: 1px solid #f8fafc;
    }
    .ref-value-item:hover { background: #f8fafc; }
    .ref-value-item:last-child { border-bottom: none; }

    .ref-value-handle {
      color: #cbd5e1;
      cursor: grab;
      font-size: 0.75rem;
      user-select: none;
      flex-shrink: 0;
    }
    .ref-value-handle:active { cursor: grabbing; }

    .ref-value-text {
      flex: 1;
      font-size: 0.8125rem;
      color: #1e293b;
      cursor: default;
    }
    .ref-value-text:hover { cursor: text; }

    .ref-value-delete {
      background: none;
      border: none;
      color: #cbd5e1;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.1s;
      opacity: 0;
      flex-shrink: 0;
    }
    .ref-value-item:hover .ref-value-delete { opacity: 1; }
    .ref-value-delete:hover { color: #dc2626; background: #fee2e2; }

    .backup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 16px;
    }
    .backup-card { margin-bottom: 0; }
  </style>
</body>
</html>
