<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amarillo ATS ‚Äî Fiche Entreprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/tailwind.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/leaflet.css" />
  <script src="js/vendor/leaflet.js"></script>
  <link rel="icon" type="image/png" href="AS_logo_only.png" />
</head>
<body>
  <nav class="sidebar">
    <div class="sidebar-logo"><img src="AS_logo_only.png" alt="Amarillo" class="sidebar-logo-icon" />Amarillo ATS</div>
    <div class="sidebar-nav">
      <a href="index.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>Dashboard</a>
      <a href="candidats.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Candidats</a>
      <a href="missions.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Missions</a>
      <a href="entreprises.html" class="active"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>Entreprises</a>
      <a href="decideurs.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>D√©cideurs</a>
      <a href="carte.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>Carte</a>
      <a href="actions.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Actions</a>
      <a href="signaux.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>Signaux</a>
      <a href="facturation.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Facturation</a>
      <a href="referentiels.html"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>R√©f√©rentiels</a>
    </div>
    <div style="padding:12px 20px;border-top:1px solid #334155;"><button onclick="UI.showConfigModal()" class="btn btn-secondary" style="width:100%;justify-content:center;font-size:0.75rem;">Configuration</button></div>
  </nav>

  <div class="main-content">
    <header class="topbar" data-entity="entreprises">
      <a href="entreprises.html" style="color:#64748b;text-decoration:none;font-size:0.8125rem;">‚Üê Retour aux entreprises</a>
      <div class="search-global"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" placeholder="Rechercher..." /><div class="search-results-dropdown"></div></div>
    </header>
    <div class="page-content" id="entreprise-content"></div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/backup-monitor.js"></script>
  <script src="js/api.js"></script>
  <script src="js/store.js"></script>
  <script src="js/components.js"></script>
  <script src="js/referentiels.js"></script>
  <script src="js/cv-parser.js"></script>
  <script src="js/company-autofill.js"></script>
  <script src="js/geocoder.js"></script>
  <script src="js/company-map-widget.js"></script>
  <script src="js/signal-regions.js"></script>
  <script src="js/signal-engine.js"></script>
  <script>
  let currentEntreprise = null;
  const entId = new URLSearchParams(window.location.search).get('id');

  const ENT_STATUTS = Referentiels.get('entreprise_statuts');
  const ENT_PRIORITES = Referentiels.get('entreprise_priorites');

  function renderEntreprisePage() {
    const e = Store.findById('entreprises', entId);
    if (!e) { document.getElementById('entreprise-content').innerHTML = '<div class="empty-state"><p>Entreprise introuvable</p></div>'; return; }
    currentEntreprise = e;
    document.title = `${e.nom} ‚Äî Amarillo ATS`;

    const decideurs = Store.filter('decideurs', d => d.entreprise_id === entId);
    const candidats = Store.filter('candidats', c => c.entreprise_actuelle_id === entId);
    const missions = Store.filter('missions', m => {
      const dec = Store.filter('decideurs', d => d.entreprise_id === entId);
      const decIds = dec.map(d => d.id);
      return (m.decideurs_ids || []).some(did => decIds.includes(did));
    });
    const actions = Store.filter('actions', a => a.entreprise_id === entId);

    // Resolve linked entreprises
    const entreprisesLiees = (e.entreprises_liees || [])
      .map(rel => {
        const linked = Store.findById('entreprises', rel.entreprise_id);
        return linked ? { ...rel, nom: linked.nom, statut: linked.statut, secteur: linked.secteur, localisation: linked.localisation } : null;
      })
      .filter(Boolean);

    // Find teasers sent to this entreprise
    const allCandidats = Store.get('candidats');
    const teasersRecus = [];
    allCandidats.forEach(c => {
      (c.presentations || []).forEach(p => {
        if (p.type === 'teaser' && p.entreprise_id === entId) {
          teasersRecus.push({ ...p, candidat_id: c.id, candidat_poste: c.poste_actuel || 'Profil' });
        }
      });
    });

    // Auto-compute dernier_contact & prochaine_relance from actions
    const todayIso = new Date().toISOString().split('T')[0];
    const doneActions = actions.filter(a => a.statut === 'Fait' && a.date_action);
    const computedDernier = doneActions.length > 0 ? doneActions.reduce((max, a) => a.date_action > max ? a.date_action : max, '') : null;
    const futureRelances = actions.filter(a => a.date_relance && a.date_relance >= todayIso && a.statut !== 'Annul√©');
    const computedRelance = futureRelances.length > 0 ? futureRelances.reduce((min, a) => a.date_relance < min ? a.date_relance : min, futureRelances[0].date_relance) : null;
    const dateUpdates = {};
    if (computedDernier && computedDernier !== e.dernier_contact) dateUpdates.dernier_contact = computedDernier;
    if (computedRelance && computedRelance !== e.prochaine_relance) dateUpdates.prochaine_relance = computedRelance;
    if (Object.keys(dateUpdates).length > 0) {
      Store.update('entreprises', entId, dateUpdates);
      Object.assign(e, dateUpdates);
    }

    document.getElementById('entreprise-content').innerHTML = `
      <div class="detail-header">
        <div style="display:flex;align-items:center;">
          <div class="detail-avatar entreprise">${(e.nom || '?')[0]}</div>
          <div>
            <h1 id="ent-name" style="cursor:pointer;" title="Cliquer pour modifier">${UI.escHtml(e.nom)}</h1>
            <div class="subtitle">${UI.escHtml(e.secteur || '')} ‚Ä¢ ${UI.escHtml(e.taille || '')} ‚Ä¢ ${UI.escHtml(e.localisation || '')}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          ${e.prochaine_relance ? (() => {
            const isOverdue = e.prochaine_relance < todayIso;
            const isToday = e.prochaine_relance === todayIso;
            const bgColor = isOverdue ? '#fef2f2' : isToday ? '#fffbeb' : '#f0fdf4';
            const borderColor = isOverdue ? '#fecaca' : isToday ? '#fde68a' : '#bbf7d0';
            const textColor = isOverdue ? '#dc2626' : isToday ? '#d97706' : '#16a34a';
            const label = isOverdue ? 'RELANCE EN RETARD' : isToday ? 'RELANCE AUJOURD\'HUI' : 'Prochaine relance';
            return `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:700;background:${bgColor};border:1.5px solid ${borderColor};color:${textColor};" title="Prochaine relance pr√©vue">üìÖ ${label} : ${UI.formatDate(e.prochaine_relance)}</span>`;
          })() : ''}
          ${UI.statusBadge(e.statut || '√Ä cibler', ENT_STATUTS, { entity: 'entreprises', recordId: entId, fieldName: 'statut', onUpdate: () => renderEntreprisePage() })}
          ${UI.statusBadge(e.priorite || '3 - Moyenne', ENT_PRIORITES, { entity: 'entreprises', recordId: entId, fieldName: 'priorite', onUpdate: () => renderEntreprisePage() })}
          <button class="btn btn-danger btn-sm" id="btn-delete-entreprise" title="Supprimer cette entreprise">üóëÔ∏è</button>
          <span class="autosave-indicator saved"><span class="sync-dot"></span> Auto-save</span>
        </div>
      </div>

      <div class="detail-grid">
        <div class="detail-main">
          <div class="card" data-accent="blue" id="ent-autofill-section">
            <div class="card-header">
              <h2>Compl√©ter les infos via IA</h2>
              <span style="font-size:0.7rem;color:#94a3b8;">gpt-4o-mini</span>
            </div>
            <div class="card-body" style="padding:16px;">
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-primary" id="btn-ent-autofill" style="display:inline-flex;align-items:center;gap:6px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  Rechercher les infos entreprise
                </button>
                <button class="btn btn-sm btn-secondary" id="btn-ent-pappers-config" style="font-size:0.6875rem;">Cl√© Pappers</button>
                <button class="btn btn-sm btn-secondary" id="btn-ent-autofill-config" style="font-size:0.6875rem;">Cl√© OpenAI</button>
              </div>
              <div id="ent-autofill-status" style="margin-top:8px;font-size:0.8125rem;"></div>
            </div>
          </div>

          <div class="card" data-accent="green">
            <div class="card-header">
              <h2>Informations</h2>
              <span class="edit-hint">cliquer sur un champ pour modifier</span>
            </div>
            <div class="card-body">
              <div class="inline-fields-grid" id="ent-info-fields"></div>
              <div id="ent-autres-sites-container" style="margin-top:12px;"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>Strat√©gie & Notes</h2>
              <span class="edit-hint">cliquer pour modifier</span>
            </div>
            <div class="card-body" id="ent-notes-fields"></div>
          </div>

          <div id="ent-signal-widget" style="margin-bottom:16px;"></div>

          <div id="ent-documents-section"></div>

          <div class="card">
            <div class="card-header">
              <h2>Entreprises li√©es (${entreprisesLiees.length})</h2>
              <button class="btn btn-primary btn-sm" id="btn-add-entreprise-liee">+ Lier une entreprise</button>
            </div>
            <div class="card-body">
              ${entreprisesLiees.length === 0 ? '<div class="empty-state"><p>Aucune entreprise li√©e</p></div>' :
                entreprisesLiees.map(rel => `
                  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">
                    <div>
                      <a href="entreprise.html?id=${rel.entreprise_id}" class="entity-link" style="font-weight:600;">${UI.escHtml(rel.nom)}</a>
                      <div style="font-size:0.75rem;color:#64748b;">${UI.escHtml(rel.secteur || '')} ‚Ä¢ ${UI.escHtml(rel.localisation || '')}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;">
                      ${UI.badge(rel.type_relation)}
                      <button class="btn-remove-link" data-linked-id="${rel.entreprise_id}" title="Retirer le lien" style="background:none;border:none;cursor:pointer;padding:2px 6px;font-size:0.875rem;color:#ef4444;">√ó</button>
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>D√©cideurs (${decideurs.length})</h2>
              <button class="btn btn-primary btn-sm" onclick="showAddDecideurModal()">+ D√©cideur</button>
            </div>
            <div class="card-body">
              ${decideurs.length === 0 ? '<div class="empty-state"><p>Aucun d√©cideur rattach√©</p></div>' :
                decideurs.map(d => `
                  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">
                    <div>
                      <a href="decideur.html?id=${d.id}" class="entity-link" style="font-weight:600;">${UI.escHtml((d.prenom||'')+' '+(d.nom||''))}</a>
                      <div style="font-size:0.75rem;color:#64748b;">${UI.escHtml(d.fonction || '')} ‚Ä¢ ${UI.escHtml(d.niveau_hierarchique || '')}</div>
                    </div>
                    <div>${UI.badge(d.priorite_prospection || d.role_decision || '')}</div>
                  </div>
                `).join('')}
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h2>Missions li√©es (${missions.length})</h2></div>
            <div class="card-body">
              ${missions.length === 0 ? '<div class="empty-state"><p>Aucune mission</p></div>' :
                missions.map(m => `
                  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">
                    <div>
                      <a href="mission.html?id=${m.id}" class="entity-link" style="font-weight:600;">${UI.escHtml(m.nom || m.ref || '')}</a>
                      <div style="font-size:0.75rem;color:#64748b;">${UI.escHtml(m.ref || '')} ‚Ä¢ ${UI.formatDate(m.date_demarrage)}</div>
                    </div>
                    <div>${UI.badge(m.statut || '')}</div>
                  </div>
                `).join('')}
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>Candidats employ√©s (${candidats.length})</h2>
              <button class="btn btn-primary btn-sm" onclick="showAddCandidatModal()">+ Candidat</button>
            </div>
            <div class="card-body">
              ${candidats.length === 0 ? '<div class="empty-state"><p>Aucun candidat</p></div>' :
                candidats.map(c => `
                  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">
                    <div>
                      <a href="candidat.html?id=${c.id}" class="entity-link" style="font-weight:600;">${UI.escHtml((c.prenom||'')+' '+(c.nom||''))}</a>
                      <div style="font-size:0.75rem;color:#64748b;">${UI.escHtml(c.poste_actuel || '')}</div>
                    </div>
                    <div>${UI.badge(c.statut)}</div>
                  </div>
                `).join('')}
            </div>
          </div>

          ${teasersRecus.length > 0 ? `
          <div class="card" data-accent="gold">
            <div class="card-header"><h2>‚úàÔ∏è Teasers re√ßus (${teasersRecus.length})</h2></div>
            <div class="card-body">
              ${teasersRecus.map(t => {
                const statusMap = {
                  'sent': 'üîµ', 'replied': 'üü¢', 'bounced': 'üî¥',
                  'auto-reply': 'üü°', 'no-reply': '‚ö™', 'draft': 'üìù'
                };
                const icon = statusMap[t.email_status] || 'üîµ';
                return '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">' +
                  '<div>' +
                    '<a href="candidat.html?id=' + t.candidat_id + '" class="entity-link" style="font-weight:600;">' + UI.escHtml(t.candidat_poste) + ' (anonymis√©)</a>' +
                    '<div style="font-size:0.75rem;color:#64748b;">' + UI.formatDate(t.date_envoi) + ' ‚Ä¢ ' + UI.escHtml(t.decideur_nom || '') + ' ‚Ä¢ ' + UI.escHtml(t.decideur_email || '') + '</div>' +
                  '</div>' +
                  '<div style="display:flex;align-items:center;gap:6px;">' +
                    '<span style="font-size:0.75rem;">' + icon + ' ' + UI.escHtml(t.statut_retour || 'En attente') + '</span>' +
                    (t.nb_relances > 0 ? '<span style="font-size:0.6875rem;color:#94a3b8;">' + t.nb_relances + ' relance(s)</span>' : '') +
                  '</div>' +
                '</div>';
              }).join('')}
            </div>
          </div>
          ` : ''}

          <div class="card">
            <div class="card-header">
              <h2>Actions (${actions.length})</h2>
              <button class="btn btn-primary btn-sm" id="btn-new-ent-action">+ Action</button>
            </div>
            <div class="card-body">
              ${actions.length === 0 ? '<div class="empty-state"><p>Aucune action</p></div>' :
                actions.map(a => `
                  <div class="ent-action-row" data-action-id="${a.id}" style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;cursor:pointer;">
                    <div>
                      <div style="font-weight:600;font-size:0.8125rem;">${UI.escHtml(a.action || '')}</div>
                      <div style="font-size:0.75rem;color:#64748b;">${UI.formatDate(a.date_action)} ‚Ä¢ ${UI.escHtml(a.canal || '')}</div>
                    </div>
                    <div>${UI.badge(a.statut || '')}</div>
                  </div>
                `).join('')}
            </div>
          </div>
        </div>

        <div class="detail-sidebar">
          <div id="ent-map-widget"></div>
          <div class="card">
            <div class="card-header"><h2>R√©sum√©</h2></div>
            <div class="card-body">
              <div style="font-size:0.75rem;color:#64748b;">Entreprises li√©es</div>
              <div style="font-size:1.25rem;font-weight:700;margin-bottom:12px;">${entreprisesLiees.length}</div>
              <div style="font-size:0.75rem;color:#64748b;">D√©cideurs</div>
              <div style="font-size:1.25rem;font-weight:700;margin-bottom:12px;">${decideurs.length}</div>
              <div style="font-size:0.75rem;color:#64748b;">Missions</div>
              <div style="font-size:1.25rem;font-weight:700;margin-bottom:12px;">${missions.length}</div>
              <div style="font-size:0.75rem;color:#64748b;">Candidats identifi√©s</div>
              <div style="font-size:1.25rem;font-weight:700;margin-bottom:12px;">${candidats.length}</div>
              <div style="font-size:0.75rem;color:#64748b;">Teasers re√ßus</div>
              <div style="font-size:1.25rem;font-weight:700;margin-bottom:12px;">${teasersRecus.length}</div>
              <div style="font-size:0.75rem;color:#64748b;">Actions</div>
              <div style="font-size:1.25rem;font-weight:700;margin-bottom:12px;">${actions.length}</div>
              ${e.google_drive_url ? `
              <div style="margin-top:16px;padding-top:12px;border-top:1px solid #e2e8f0;">
                <div style="font-size:0.75rem;font-weight:600;color:#64748b;text-transform:uppercase;margin-bottom:4px;">Liens externes</div>
                <a href="${UI.escHtml(e.google_drive_url)}" target="_blank" class="entity-link" style="display:inline-flex;align-items:center;gap:4px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                  Google Drive
                </a>
              </div>
              ` : ''}
              <div id="ent-dates-fields" style="margin-top:16px;padding-top:12px;border-top:1px solid #e2e8f0;"></div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Inline edit for company name (click on h1)
    document.getElementById('ent-name')?.addEventListener('click', () => {
      UI.modal('Modifier le nom', `
        <div class="form-group"><label>Nom</label><input type="text" id="en-nom" value="${UI.escHtml(e.nom || '')}" /></div>
      `, {
        onSave: async (overlay) => {
          await Store.update('entreprises', entId, { nom: overlay.querySelector('#en-nom').value.trim() });
          UI.toast('Nom mis √† jour');
          renderEntreprisePage();
        }
      });
    });

    document.getElementById('btn-delete-entreprise')?.addEventListener('click', () => {
      UI.modal('Supprimer l\'entreprise', `
        <p style="color:#dc2626;font-weight:600;">Supprimer <strong>${UI.escHtml(e.nom || '')}</strong> ?</p>
        <p style="font-size:0.875rem;color:#64748b;margin-top:8px;">Cette action est irr√©versible. Les d√©cideurs rattach√©s ne seront pas supprim√©s.</p>
      `, {
        saveLabel: 'Supprimer',
        onSave: async () => {
          await Store.remove('entreprises', entId);
          UI.toast('Entreprise supprim√©e');
          setTimeout(() => window.location.href = 'entreprises.html', 500);
        }
      });
    });

    // Inline editable fields ‚Äî Info
    UI.inlineEdit('ent-info-fields', {
      entity: 'entreprises', recordId: entId,
      fields: [
        { key: 'secteur', label: 'Secteur', type: 'select', options: Referentiels.get('entreprise_secteurs') },
        { key: 'taille', label: 'Taille', type: 'select', options: Referentiels.get('entreprise_tailles') },
        { key: 'ca', label: 'CA', type: 'select', options: ['< 5 M‚Ç¨', '5-20 M‚Ç¨', '20-50 M‚Ç¨', '50-100 M‚Ç¨', '100-250 M‚Ç¨', '250 M‚Ç¨+'] },
        { key: 'localisation', label: 'Localisation', type: 'autocomplete', options: () => Referentiels.get('localisations'), refKey: 'localisations' },
        { key: 'telephone', label: 'T√©l√©phone', type: 'text' },
        { key: 'site_web', label: 'Site web', type: 'text', render: (v) => v ? `<a href="${UI.escHtml(v)}" target="_blank" class="entity-link">${UI.escHtml(v)}</a>` : '' },
        { key: 'linkedin', label: 'LinkedIn', type: 'text', render: (v) => v ? UI.linkedinBadge(v, { compact: true }) : '' },
        { key: 'source', label: 'Source', type: 'text' },
        { key: 'siege_adresse', label: 'Adresse (si√®ge)', type: 'textarea', render: (v) => v ? `<span style="white-space:pre-wrap;">${UI.escHtml(v)}</span>` : '' },
        { key: 'siege_code_postal', label: 'Code postal', type: 'address_autocomplete', role: 'postcode', siblingKey: 'siege_ville' },
        { key: 'siege_ville', label: 'Ville', type: 'address_autocomplete', role: 'city', siblingKey: 'siege_code_postal' },
      ]
    });

    // Autres sites (tag system)
    renderAutresSites(e);

    // Inline editable ‚Äî Notes & Strategy
    UI.inlineEdit('ent-notes-fields', {
      entity: 'entreprises', recordId: entId,
      fields: [
        { key: 'angle_approche', label: "Angle d'approche", type: 'textarea', render: (v) => v ? `<span style="white-space:pre-wrap;">${UI.escHtml(v)}</span>` : '' },
        { key: 'notes', label: 'Notes', type: 'textarea', render: (v) => v ? `<span style="white-space:pre-wrap;">${UI.escHtml(v)}</span>` : '' },
      ]
    });

    // Documents section
    UI.documentsSection('ent-documents-section', {
      entity: 'entreprises',
      recordId: entId,
      docTypesKey: 'document_types_entreprise',
      onUpdate: () => renderEntreprisePage(),
    });

    // Inline editable ‚Äî Dates
    UI.inlineEdit('ent-dates-fields', {
      entity: 'entreprises', recordId: entId,
      fields: [
        { key: 'dernier_contact', label: 'Dernier contact', type: 'date', render: (v) => UI.formatDate(v) },
        { key: 'prochaine_relance', label: 'Prochaine relance', type: 'date', render: (v) => {
            if (!v) return '';
            const today = new Date().toISOString().split('T')[0];
            const isOverdue = v < today;
            const isToday = v === today;
            const color = isOverdue ? '#dc2626' : isToday ? '#d97706' : '#16a34a';
            const weight = (isOverdue || isToday) ? 'font-weight:700;' : '';
            return `<span style="color:${color};${weight}">${UI.formatDate(v)}${isOverdue ? ' (en retard)' : isToday ? ' (aujourd\'hui)' : ''}</span>`;
          }},
      ]
    });

    // Map widget
    CompanyMapWidget.init('ent-map-widget', {
      localisation: e.localisation,
      siege_ville: e.siege_ville,
      siege_code_postal: e.siege_code_postal,
      siege_adresse: e.siege_adresse,
      autres_sites: e.autres_sites || [],
      nom: e.nom
    });

    // Action row click handlers
    document.querySelectorAll('.ent-action-row').forEach(row => {
      row.addEventListener('click', () => showEntActionDetail(row.dataset.actionId));
    });

    // New action button
    document.getElementById('btn-new-ent-action')?.addEventListener('click', (ev) => {
      ev.stopPropagation();
      showNewEntAction();
    });

    // Entreprises li√©es buttons
    document.getElementById('btn-add-entreprise-liee')?.addEventListener('click', showAddEntrepriseLieeModal);
    document.querySelectorAll('.btn-remove-link').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        removeEntrepriseLiee(btn.dataset.linkedId);
      });
    });

    // Company Autofill IA ‚Äî event handlers
    document.getElementById('btn-ent-autofill')?.addEventListener('click', async () => {
      const hasPappers = !!CompanyAutofill.getPappersKey();
      const hasOpenAI = !!CVParser.getOpenAIKey();
      if (!hasPappers && !hasOpenAI) {
        CompanyAutofill.showPappersConfigModal();
        return;
      }

      const btn = document.getElementById('btn-ent-autofill');
      const statusEl = document.getElementById('ent-autofill-status');
      btn.disabled = true;
      btn.innerHTML = '<span style="width:16px;height:16px;border:2px solid #bfdbfe;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;"></span> Recherche en cours...';
      statusEl.innerHTML = '';

      try {
        const currentValues = {
          nom: e.nom || '', secteur: e.secteur || '', taille: e.taille || '',
          ca: e.ca || '', localisation: e.localisation || '', site_web: e.site_web || '',
          linkedin: e.linkedin || '', telephone: e.telephone || '', siege_adresse: e.siege_adresse || '',
          siege_code_postal: e.siege_code_postal || '', siege_ville: e.siege_ville || '',
          angle_approche: e.angle_approche || '', notes: e.notes || '',
          _decideurs: decideurs.map(d => ({ prenom: d.prenom, nom: d.nom, fonction: d.fonction })),
        };

        const extracted = await CompanyAutofill.fetchCompanyInfo(e.nom, currentValues, {
          onStatusUpdate: (msg) => { statusEl.innerHTML = '<span style="color:#3b82f6;">' + UI.escHtml(msg) + '</span>'; },
        });

        if (!extracted) { statusEl.innerHTML = ''; return; } // User cancelled

        CompanyAutofill.showReviewModal(extracted, currentValues, {
          title: 'R√©sultats Autofill ‚Äî ' + e.nom,
          onApply: async (updates) => {
            await Store.update('entreprises', entId, updates);
            Object.assign(e, updates);
            UI.toast(Object.keys(updates).length + ' champ(s) mis √† jour');
            renderEntreprisePage();
          }
        });

        statusEl.innerHTML = '';
      } catch (err) {
        statusEl.innerHTML = '<span style="color:#dc2626;">Erreur : ' + UI.escHtml(err.message) + '</span>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Rechercher les infos entreprise';
      }
    });

    document.getElementById('btn-ent-pappers-config')?.addEventListener('click', () => {
      CompanyAutofill.showPappersConfigModal();
    });

    document.getElementById('btn-ent-autofill-config')?.addEventListener('click', () => {
      CVParser.showKeyConfigModal();
    });
  }


  // --- Action management functions ---

  function showEntActionDetail(actionId) {
    const action = Store.findById('actions', actionId);
    if (!action) return;
    const missionName = action.mission_id ? (Store.resolve('missions', action.mission_id)?.displayName || '') : '';
    const candidatName = action.candidat_id ? (Store.resolve('candidats', action.candidat_id)?.displayName || '') : '';

    const bodyHtml = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
        <div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Action</div><div style="font-size:0.875rem;">${UI.escHtml(action.action || '‚Äî')}</div></div>
        <div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Type</div><div style="font-size:0.875rem;">${UI.escHtml(action.type_action || '‚Äî')}</div></div>
        <div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Canal</div><div>${UI.badge(action.canal)}</div></div>
        <div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Statut</div><div>${UI.badge(action.statut)}</div></div>
        <div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Date</div><div style="font-size:0.875rem;">${UI.formatDate(action.date_action)}</div></div>
        <div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">R√©ponse</div><div style="font-size:0.875rem;">${action.reponse ? '<span style="color:#16a34a;font-weight:600;">Oui</span>' : 'Non'}</div></div>
        ${missionName ? `<div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Mission</div><div style="font-size:0.875rem;">${UI.escHtml(missionName)}</div></div>` : ''}
        ${candidatName ? `<div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Candidat</div><div style="font-size:0.875rem;">${UI.escHtml(candidatName)}</div></div>` : ''}
        ${action.date_relance ? `<div><div style="font-size:0.75rem;font-weight:600;color:#64748b;">Relance</div><div style="font-size:0.875rem;">${UI.formatDate(action.date_relance)}</div></div>` : ''}
      </div>
      ${action.message_notes ? `<div style="margin-bottom:12px;"><div style="font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px;">Message / Notes</div><div style="background:#f8fafc;border-radius:8px;padding:12px;font-size:0.8125rem;white-space:pre-wrap;max-height:300px;overflow-y:auto;border:1px solid #e2e8f0;">${UI.escHtml(action.message_notes)}</div></div>` : ''}
      ${action.next_step ? `<div style="margin-bottom:16px;"><div style="font-size:0.75rem;font-weight:600;color:#c9a000;margin-bottom:4px;">‚Üí Next step</div><div style="font-size:0.875rem;">${UI.escHtml(action.next_step)}</div></div>` : ''}
      <div style="display:flex;gap:8px;border-top:1px solid #e2e8f0;padding-top:16px;">
        <button class="btn btn-primary btn-sm" id="ent-action-edit-btn" style="flex:1;">‚úèÔ∏è Modifier</button>
        <button class="btn btn-secondary btn-sm" id="ent-action-toggle-btn" style="flex:1;">${action.statut === 'Fait' ? '‚Ü©Ô∏è Remettre √† faire' : '‚úÖ Marquer fait'}</button>
        <button class="btn btn-danger btn-sm" id="ent-action-delete-btn">üóëÔ∏è Supprimer</button>
      </div>
    `;

    const { close } = UI.modal('D√©tail de l\'action', bodyHtml, { width: 560 });

    setTimeout(() => {
      document.getElementById('ent-action-edit-btn')?.addEventListener('click', () => {
        close();
        showEditEntAction(action);
      });
      document.getElementById('ent-action-toggle-btn')?.addEventListener('click', async () => {
        const newStatut = action.statut === 'Fait' ? '√Ä faire' : 'Fait';
        await Store.update('actions', actionId, { statut: newStatut });
        UI.toast('Statut mis √† jour');
        close();
        renderEntreprisePage();
      });
      document.getElementById('ent-action-delete-btn')?.addEventListener('click', () => {
        close();
        UI.modal('Confirmer la suppression', `<p style="color:#dc2626;">Supprimer l'action ¬´ ${UI.escHtml(action.action)} ¬ª ?</p>`, {
          saveLabel: 'Supprimer',
          onSave: async () => {
            await Store.remove('actions', actionId);
            UI.toast('Action supprim√©e');
            renderEntreprisePage();
          }
        });
      });
    }, 50);
  }

  function showEditEntAction(a) {
    const allMissions = Store.get('missions');
    const allCandidats = Store.get('candidats');
    const allDecideurs = Store.get('decideurs');

    UI.modal('Modifier l\'action', `
      <div class="form-group"><label>Action</label><input type="text" id="ea-action" value="${UI.escHtml(a.action || '')}" /></div>
      <div class="form-row">
        <div class="form-group"><label>Type</label><select id="ea-type">${Referentiels.get('action_types').map(s=>`<option value="${s}" ${a.type_action===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div class="form-group"><label>Canal</label><select id="ea-canal">${Referentiels.get('action_canaux').map(s=>`<option value="${s}" ${a.canal===s?'selected':''}>${s}</option>`).join('')}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Statut</label><select id="ea-statut"><option value="√Ä faire" ${(a.statut==='√Ä faire'||a.statut==='A faire')?'selected':''}>√Ä faire</option><option value="En cours" ${a.statut==='En cours'?'selected':''}>En cours</option><option value="Fait" ${a.statut==='Fait'?'selected':''}>Fait</option><option value="Annul√©" ${a.statut==='Annul√©'?'selected':''}>Annul√©</option></select></div>
        <div class="form-group"><label>Date</label><input type="date" id="ea-date" value="${a.date_action || ''}" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Candidat</label><select id="ea-candidat"><option value="">‚Äî</option>${allCandidats.map(c=>`<option value="${c.id}" ${a.candidat_id===c.id?'selected':''}>${UI.escHtml((c.prenom||'')+' '+(c.nom||''))}</option>`).join('')}</select></div>
        <div class="form-group"><label>D√©cideur</label><select id="ea-decideur"><option value="">‚Äî</option>${allDecideurs.map(d=>`<option value="${d.id}" ${a.decideur_id===d.id?'selected':''}>${UI.escHtml((d.prenom||'')+' '+(d.nom||''))}</option>`).join('')}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Mission</label><select id="ea-mission"><option value="">‚Äî</option>${allMissions.map(m=>`<option value="${m.id}" ${a.mission_id===m.id?'selected':''}>${UI.escHtml(m.nom||m.ref)}</option>`).join('')}</select></div>
        <div class="form-group"><label>R√©ponse</label><select id="ea-reponse"><option value="false" ${!a.reponse?'selected':''}>Non</option><option value="true" ${a.reponse?'selected':''}>Oui</option></select></div>
      </div>
      <div class="form-group"><label>Message / Notes</label><textarea id="ea-notes" style="min-height:120px;">${UI.escHtml(a.message_notes || '')}</textarea></div>
      <div class="form-row">
        <div class="form-group"><label>Next step</label><input type="text" id="ea-next" value="${UI.escHtml(a.next_step || '')}" /></div>
        <div class="form-group"><label>Relance</label><input type="date" id="ea-relance" value="${a.date_relance || ''}" /></div>
      </div>
    `, {
      width: 640,
      onSave: async (overlay) => {
        const updatedData = {
          action: overlay.querySelector('#ea-action').value.trim(),
          type_action: overlay.querySelector('#ea-type').value,
          canal: overlay.querySelector('#ea-canal').value,
          statut: overlay.querySelector('#ea-statut').value,
          date_action: overlay.querySelector('#ea-date').value,
          candidat_id: overlay.querySelector('#ea-candidat').value || null,
          decideur_id: overlay.querySelector('#ea-decideur').value || null,
          mission_id: overlay.querySelector('#ea-mission').value || null,
          reponse: overlay.querySelector('#ea-reponse').value === 'true',
          message_notes: overlay.querySelector('#ea-notes').value.trim(),
          next_step: overlay.querySelector('#ea-next').value.trim(),
          date_relance: overlay.querySelector('#ea-relance').value || null,
        };
        await Store.update('actions', a.id, updatedData);
        await Store.syncRelanceDates({ ...a, ...updatedData, entreprise_id: a.entreprise_id || entId });
        UI.toast('Action mise √† jour');
        renderEntreprisePage();
      }
    });
  }

  function showNewEntAction() {
    const allMissions = Store.get('missions');
    const allCandidats = Store.get('candidats');
    const allDecideurs = Store.filter('decideurs', d => d.entreprise_id === entId);
    const todayStr = new Date().toISOString().split('T')[0];

    UI.modal('Nouvelle action', `
      <div class="form-group"><label>Action</label><input type="text" id="na-action" placeholder="Ex: Message LinkedIn, Appel..." /></div>
      <div class="form-row">
        <div class="form-group"><label>Type</label><select id="na-type">${Referentiels.get('action_types').map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
        <div class="form-group"><label>Canal</label><select id="na-canal">${Referentiels.get('action_canaux').map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Statut</label><select id="na-statut"><option value="√Ä faire">√Ä faire</option><option value="En cours">En cours</option><option value="Fait">Fait</option><option value="Annul√©">Annul√©</option></select></div>
        <div class="form-group"><label>Date</label><input type="date" id="na-date" value="${todayStr}" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Candidat</label><select id="na-candidat"><option value="">‚Äî</option>${allCandidats.map(c=>`<option value="${c.id}">${UI.escHtml((c.prenom||'')+' '+(c.nom||''))}</option>`).join('')}</select></div>
        <div class="form-group"><label>D√©cideur</label><select id="na-decideur"><option value="">‚Äî</option>${allDecideurs.map(d=>`<option value="${d.id}">${UI.escHtml((d.prenom||'')+' '+(d.nom||''))}</option>`).join('')}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Mission</label><select id="na-mission"><option value="">‚Äî</option>${allMissions.map(m=>`<option value="${m.id}">${UI.escHtml(m.nom||m.ref)}</option>`).join('')}</select></div>
        <div class="form-group"><label>R√©ponse</label><select id="na-reponse"><option value="false">Non</option><option value="true">Oui</option></select></div>
      </div>
      <div class="form-group"><label>Message / Notes</label><textarea id="na-notes" style="min-height:120px;"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label>Next step</label><input type="text" id="na-next" /></div>
        <div class="form-group"><label>Relance</label><input type="date" id="na-relance" /></div>
      </div>
    `, {
      width: 640,
      onSave: async (overlay) => {
        const data = {
          id: API.generateId('act'),
          action: overlay.querySelector('#na-action').value.trim(),
          type_action: overlay.querySelector('#na-type').value,
          canal: overlay.querySelector('#na-canal').value,
          statut: overlay.querySelector('#na-statut').value,
          date_action: overlay.querySelector('#na-date').value,
          candidat_id: overlay.querySelector('#na-candidat').value || null,
          decideur_id: overlay.querySelector('#na-decideur').value || null,
          mission_id: overlay.querySelector('#na-mission').value || null,
          entreprise_id: entId,
          reponse: overlay.querySelector('#na-reponse').value === 'true',
          message_notes: overlay.querySelector('#na-notes').value.trim(),
          next_step: overlay.querySelector('#na-next').value.trim(),
          date_relance: overlay.querySelector('#na-relance').value || null,
          priorite: null,
          phase: '',
          finalite: '',
          objectif: '',
          moment_suivi: '',
        };
        await Store.add('actions', data);
        await Store.syncRelanceDates(data);
        UI.toast('Action cr√©√©e');
        renderEntreprisePage();
      }
    });
  }

  // --- Entreprises li√©es functions ---

  const RELATION_INVERSE = {
    'Soci√©t√© m√®re': 'Filiale',
    'Filiale': 'Soci√©t√© m√®re',
    'M√™me groupe': 'M√™me groupe',
    'Partenaire': 'Partenaire',
  };

  function showAddEntrepriseLieeModal() {
    const bodyHtml = `
      <div class="form-group">
        <label>Entreprise</label>
        <div style="position:relative;">
          <input type="text" id="link-ent-name" placeholder="Rechercher une entreprise..." autocomplete="off" />
          <input type="hidden" id="link-ent-id" />
        </div>
      </div>
      <div class="form-group">
        <label>Type de relation</label>
        <select id="link-ent-type">
          <option value="Soci√©t√© m√®re">Soci√©t√© m√®re</option>
          <option value="Filiale">Filiale</option>
          <option value="M√™me groupe">M√™me groupe</option>
          <option value="Partenaire">Partenaire</option>
        </select>
      </div>
    `;

    UI.modal('Lier une entreprise', bodyHtml, {
      width: 480,
      onSave: async () => {
        const linkedId = document.getElementById('link-ent-id').value;
        const type = document.getElementById('link-ent-type').value;
        if (!linkedId || linkedId === entId) { UI.toast('S√©lectionnez une entreprise valide'); return; }

        const existing = (currentEntreprise.entreprises_liees || []);
        if (existing.some(r => r.entreprise_id === linkedId)) { UI.toast('Cette entreprise est d√©j√† li√©e'); return; }

        // Update side A (current entreprise)
        const newLinks = [...existing, { entreprise_id: linkedId, type_relation: type }];
        await Store.update('entreprises', entId, { entreprises_liees: newLinks });

        // Update side B (linked entreprise) ‚Äî inverse relation
        const linked = Store.findById('entreprises', linkedId);
        if (linked) {
          const linkedLinks = [...(linked.entreprises_liees || []), { entreprise_id: entId, type_relation: RELATION_INVERSE[type] }];
          await Store.update('entreprises', linkedId, { entreprises_liees: linkedLinks });
        }

        UI.toast('Entreprise li√©e');
        renderEntreprisePage();
      }
    });
    UI.entrepriseAutocomplete('link-ent-name', 'link-ent-id');
  }

  async function removeEntrepriseLiee(linkedId) {
    if (!confirm('Retirer ce lien ?')) return;

    // Remove from side A
    const newLinks = (currentEntreprise.entreprises_liees || []).filter(r => r.entreprise_id !== linkedId);
    await Store.update('entreprises', entId, { entreprises_liees: newLinks });

    // Remove from side B
    const linked = Store.findById('entreprises', linkedId);
    if (linked) {
      const linkedLinks = (linked.entreprises_liees || []).filter(r => r.entreprise_id !== entId);
      await Store.update('entreprises', linkedId, { entreprises_liees: linkedLinks });
    }

    UI.toast('Lien retir√©');
    renderEntreprisePage();
  }

  function renderAutresSites(e) {
    const sites = e.autres_sites || [];
    const container = document.getElementById('ent-autres-sites-container');
    if (!container) return;
    container.innerHTML = `
      <div style="padding:8px 0;border-top:1px solid #e2e8f0;">
        <div style="font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:8px;">Autres sites</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;" id="autres-sites-tags">
          ${sites.map((s, i) => `<span class="badge" style="background:#e0e7ff;color:#4338ca;padding:4px 8px;font-size:0.8125rem;display:inline-flex;align-items:center;gap:4px;">${UI.escHtml(s)}<button data-idx="${i}" style="background:none;border:none;cursor:pointer;color:#4338ca;font-size:1rem;line-height:1;padding:0 2px;" title="Retirer">&times;</button></span>`).join('')}
        </div>
        <div style="display:flex;gap:6px;">
          <input type="text" id="autre-site-input" placeholder="Ajouter un site..." style="flex:1;padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:0.8125rem;" />
          <button id="btn-add-site" class="btn btn-primary btn-sm">+</button>
        </div>
      </div>
    `;
    // Add site
    const addSite = async () => {
      const input = document.getElementById('autre-site-input');
      const val = input.value.trim();
      if (!val) return;
      const updated = [...sites, val];
      await Store.update('entreprises', entId, { autres_sites: updated });
      e.autres_sites = updated;
      renderAutresSites(e);
    };
    document.getElementById('btn-add-site')?.addEventListener('click', addSite);
    document.getElementById('autre-site-input')?.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') { ev.preventDefault(); addSite(); }
    });
    // Remove site
    container.querySelectorAll('[data-idx]').forEach(btn => {
      btn.addEventListener('click', async (ev) => {
        ev.stopPropagation();
        const idx = parseInt(btn.dataset.idx);
        const updated = sites.filter((_, i) => i !== idx);
        await Store.update('entreprises', entId, { autres_sites: updated });
        e.autres_sites = updated;
        renderAutresSites(e);
      });
    });
  }

  function showAddDecideurModal() {
    const body = `
      <div id="dup-warning-decideur-ent"></div>
      <div class="form-row">
        <div class="form-group"><label>Pr√©nom</label><input type="text" id="nd-prenom"></div>
        <div class="form-group"><label>Nom</label><input type="text" id="nd-nom"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Fonction</label><input type="text" id="nd-fonction"></div>
        <div class="form-group"><label>Niveau hi√©rarchique</label>
          <select id="nd-niveau">
            <option value="">‚Äî</option>
            ${Referentiels.get('decideur_niveaux_hierarchiques').map(n => `<option value="${n}">${n}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>R√¥le d√©cision</label>
          <select id="nd-role">
            <option value="">‚Äî</option>
            ${Referentiels.get('decideur_roles_decision').map(r => `<option value="${r}">${r}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label>Priorit√© prospection</label>
          <select id="nd-priorite">
            <option value="">‚Äî</option>
            ${Referentiels.get('decideur_priorites_prospection').map(p => `<option value="${p}">${p}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Email</label><input type="email" id="nd-email"></div>
        <div class="form-group"><label>T√©l√©phone</label><input type="text" id="nd-telephone"></div>
      </div>
      <div class="form-group"><label>LinkedIn</label><input type="text" id="nd-linkedin"></div>
    `;

    UI.modal('Ajouter un d√©cideur', body, {
      width: 640,
      onSave: async () => {
        const nom = document.getElementById('nd-nom').value.trim();
        const prenom = document.getElementById('nd-prenom').value.trim();
        if (!nom) { alert('Le nom est requis'); return; }

        const decideur = {
          id: 'dec_' + Date.now(),
          prenom,
          nom,
          entreprise_id: entId,
          fonction: document.getElementById('nd-fonction').value.trim(),
          niveau_hierarchique: document.getElementById('nd-niveau').value,
          role_decision: document.getElementById('nd-role').value,
          priorite_prospection: document.getElementById('nd-priorite').value,
          email: document.getElementById('nd-email').value.trim(),
          telephone: document.getElementById('nd-telephone').value.trim(),
          linkedin: document.getElementById('nd-linkedin').value.trim(),
          localisation: currentEntreprise.localisation || '',
          missions_ids: [],
          dernier_contact: null,
          prochaine_relance: null,
        };
        await Store.add('decideurs', decideur);
        renderEntreprisePage();
        UI.toast('D√©cideur ajout√©');
      }
    });

    DuplicateDetector.attachLiveCheck(
      { prenom: 'nd-prenom', nom: 'nd-nom', email: 'nd-email', entreprise_id: { value: entId } },
      (vals) => DuplicateDetector.findDecideurDuplicates({ ...vals, entreprise_id: entId }),
      'dup-warning-decideur-ent'
    );
  }

  function showAddCandidatModal() {
    const body = `
      <div id="dup-warning-candidat-ent"></div>
      <div class="form-row">
        <div class="form-group"><label>Pr√©nom</label><input type="text" id="nc-prenom"></div>
        <div class="form-group"><label>Nom</label><input type="text" id="nc-nom"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Poste actuel</label><input type="text" id="nc-poste"></div>
        <div class="form-group"><label>Poste cible</label><input type="text" id="nc-poste-cible"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Statut</label>
          <select id="nc-statut">
            ${Referentiels.get('candidat_statuts').map(s => '<option value="' + s + '">' + s + '</option>').join('')}
          </select>
        </div>
        <div class="form-group"><label>Niveau</label>
          <select id="nc-niveau">
            <option value="">‚Äî</option>
            ${Referentiels.get('candidat_niveaux').map(s => '<option value="' + s + '">' + s + '</option>').join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Email</label><input type="email" id="nc-email"></div>
        <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="nc-telephone"></div>
      </div>
      <div class="form-group"><label>LinkedIn</label><input type="url" id="nc-linkedin"></div>
      <div class="form-group"><label>Localisation</label><input type="text" id="nc-localisation" value="${UI.escHtml(currentEntreprise.localisation || '')}"></div>
      <div class="form-group"><label>Notes</label><textarea id="nc-notes"></textarea></div>
      <p style="font-size:0.75rem;color:#64748b;margin-top:4px;">L'entreprise <strong>${UI.escHtml(currentEntreprise.nom)}</strong> sera automatiquement associ√©e.</p>
    `;

    UI.modal('Ajouter un candidat', body, {
      width: 600,
      onSave: async () => {
        const nom = document.getElementById('nc-nom').value.trim();
        const prenom = document.getElementById('nc-prenom').value.trim();
        if (!nom) {
          UI.toast('Le nom est obligatoire', 'error');
          throw new Error('validation');
        }

        const candidat = {
          id: API.generateId('cand'),
          prenom,
          nom,
          poste_actuel: document.getElementById('nc-poste').value.trim(),
          poste_cible: document.getElementById('nc-poste-cible').value.trim(),
          entreprise_actuelle_id: entId,
          statut: document.getElementById('nc-statut').value,
          niveau: document.getElementById('nc-niveau').value,
          email: document.getElementById('nc-email').value.trim(),
          telephone: document.getElementById('nc-telephone').value.trim(),
          linkedin: document.getElementById('nc-linkedin').value.trim(),
          localisation: document.getElementById('nc-localisation').value.trim(),
          notes: document.getElementById('nc-notes').value.trim(),
          open_to_work: null,
          ambassadeur: null,
          salaire_fixe_actuel: 0,
          variable_actuel: 0,
          package_souhaite_min: 0,
          package_souhaite: 0,
          preavis: '',
          diplome: '',
          origine: '',
          recommande_par: '',
          date_disponibilite: '',
          teletravail: '',
          rtt: null,
          date_naissance: '',
          adresse_ligne1: '',
          code_postal: '',
          ville: '',
          profile_code: '',
          debut_poste_actuel: '',
          debut_carriere: '',
          synthese_30s: '',
          parcours_cible: '',
          package_attentes: '',
          motivation_drivers: '',
          motivation_changement: '',
          fit_poste: '',
          fit_culture: '',
          risques: '',
          lecture_recruteur: '',
          nb_rtt: 0,
          missions_ids: [],
          decideur_connu_ids: [],
          candidats_lies_ids: [],
          manager_id: null,
          n2_id: null,
          documents: [],
          google_drive_url: '',
          dernier_contact: null,
          prochaine_relance: null,
          created_at: new Date().toISOString(),
        };
        await Store.add('candidats', candidat);
        renderEntreprisePage();
        UI.toast('Candidat ajout√©');
      }
    });

    UI.localisationAutocomplete('nc-localisation');

    DuplicateDetector.attachLiveCheck(
      { prenom: 'nc-prenom', nom: 'nc-nom', email: 'nc-email', telephone: 'nc-telephone', linkedin: 'nc-linkedin' },
      (vals) => DuplicateDetector.findCandidatDuplicates(vals),
      'dup-warning-candidat-ent'
    );
  }

  (async function() {
    if (!API.isConfigured()) { UI.showConfigModal(); return; }
    if (!entId) { window.location.href = 'entreprises.html'; return; }
    await Store.loadAll();
    UI.initGlobalSearch();
    renderEntreprisePage();
    if (typeof SignalEngine !== 'undefined') {
      SignalEngine.renderEntrepriseWidget('ent-signal-widget', entId);
    }
  })();
  </script>
</body>
</html>
