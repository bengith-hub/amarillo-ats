<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Migration : Rattacher candidats → entreprises</title>
  <style>
    body { font-family: 'Inter', sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; background: #f8fafc; }
    h1 { color: #1e293b; }
    p { color: #475569; margin-bottom: 16px; }
    .log { background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 12px; font-family: monospace; font-size: 13px; max-height: 600px; overflow-y: auto; white-space: pre-wrap; }
    .success { color: #4ade80; }
    .skip { color: #fbbf24; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warn { color: #fb923c; }
    button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 10px 5px; }
    button:hover { background: #2563eb; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .summary { background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; margin-top: 20px; }
    .summary h3 { margin-top: 0; }
  </style>
</head>
<body>
  <h1>Rattacher candidats aux entreprises</h1>
  <p>
    Ce script cherche les candidats sans <code>entreprise_actuelle_id</code> et tente de les rattacher
    à une entreprise existante en comparant le champ texte (<code>entreprise_actuelle</code> ou <code>entreprise_nom</code>)
    avec les noms des entreprises en base.
  </p>

  <button id="btn-dry" onclick="run(true)">Dry run (aperçu)</button>
  <button id="btn-run" onclick="run(false)">Exécuter le rattachement</button>

  <div class="log" id="log"></div>
  <div class="summary" id="summary" style="display:none;"></div>

  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/store.js"></script>
  <script>
    const logEl = document.getElementById('log');
    const summaryEl = document.getElementById('summary');

    function log(msg, cls = '') {
      logEl.innerHTML += cls ? `<span class="${cls}">${msg}</span>\n` : msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    function normalize(str) {
      return (str || '').trim().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove accents
        .replace(/[^a-z0-9\s]/g, '') // remove special chars
        .replace(/\s+/g, ' ');
    }

    async function run(dryRun) {
      document.getElementById('btn-dry').disabled = true;
      document.getElementById('btn-run').disabled = true;
      logEl.innerHTML = '';
      summaryEl.style.display = 'none';

      log(dryRun ? '=== DRY RUN (aucune modification) ===' : '=== EXÉCUTION ===', 'info');
      log('Chargement des données...');

      await Store.loadAll();
      const candidats = Store.get('candidats');
      const entreprises = Store.get('entreprises');

      log(`${candidats.length} candidats, ${entreprises.length} entreprises chargées`, 'info');

      // Build lookup: normalized name → entreprise
      const entLookup = {};
      entreprises.forEach(e => {
        const key = normalize(e.nom);
        if (key) entLookup[key] = e;
      });

      let linked = 0;
      let alreadyLinked = 0;
      let noName = 0;
      let noMatch = 0;
      const unmatched = [];

      for (const c of candidats) {
        const fullName = `${c.prenom || ''} ${c.nom || ''}`.trim();

        // Already has a valid link
        if (c.entreprise_actuelle_id) {
          const ent = entreprises.find(e => e.id === c.entreprise_actuelle_id);
          if (ent) {
            alreadyLinked++;
            continue;
          }
          // ID exists but entreprise not found — try to re-link by name
        }

        // Get text name from various possible fields
        const entName = c.entreprise_actuelle || c.entreprise_nom || '';
        if (!entName.trim()) {
          noName++;
          log(`  ${fullName} → pas de nom d'entreprise`, 'skip');
          continue;
        }

        // Try exact match (normalized)
        const key = normalize(entName);
        let match = entLookup[key];

        // Try fuzzy: check if candidate's company name is contained in an entreprise name or vice versa
        if (!match) {
          for (const e of entreprises) {
            const eKey = normalize(e.nom);
            if (eKey.includes(key) || key.includes(eKey)) {
              match = e;
              break;
            }
          }
        }

        if (match) {
          linked++;
          log(`  ${fullName} → "${entName}" → ${match.nom} (${match.id})`, 'success');
          if (!dryRun) {
            await Store.update('candidats', c.id, { entreprise_actuelle_id: match.id });
            // Small delay to respect rate limits
            await new Promise(r => setTimeout(r, 200));
          }
        } else {
          noMatch++;
          unmatched.push({ candidat: fullName, entreprise: entName });
          log(`  ${fullName} → "${entName}" → AUCUNE CORRESPONDANCE`, 'warn');
        }
      }

      log('');
      log('=== RÉSULTAT ===', 'info');
      log(`  Déjà rattachés : ${alreadyLinked}`, 'info');
      log(`  Rattachés maintenant : ${linked}`, 'success');
      log(`  Sans nom d'entreprise : ${noName}`, 'skip');
      log(`  Sans correspondance : ${noMatch}`, noMatch > 0 ? 'warn' : 'info');

      if (unmatched.length > 0) {
        summaryEl.style.display = 'block';
        summaryEl.innerHTML = `
          <h3>Candidats non rattachés (${unmatched.length})</h3>
          <p style="font-size:13px;color:#64748b;">Ces candidats ont un nom d'entreprise qui ne correspond à aucune entreprise en base.
          Vous pouvez les rattacher manuellement ou créer les entreprises manquantes.</p>
          <table style="width:100%;font-size:13px;border-collapse:collapse;">
            <tr style="text-align:left;border-bottom:2px solid #e2e8f0;">
              <th style="padding:8px;">Candidat</th>
              <th style="padding:8px;">Entreprise (texte)</th>
            </tr>
            ${unmatched.map(u => `<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:8px;">${u.candidat}</td><td style="padding:8px;">${u.entreprise}</td></tr>`).join('')}
          </table>
        `;
      }

      if (!dryRun) {
        log('');
        log('Migration terminée. Rechargez l\'application pour voir les changements.', 'success');
      }

      document.getElementById('btn-dry').disabled = false;
      document.getElementById('btn-run').disabled = false;
    }
  </script>
</body>
</html>
